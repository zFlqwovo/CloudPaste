<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CloudPaste PWA åŠŸèƒ½æµ‹è¯•</title>
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#0ea5e9" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        line-height: 1.6;
        color: #333;
        background: #f5f5f5;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #0ea5e9, #3b82f6);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .content {
        padding: 30px;
      }

      .test-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .test-card {
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        transition: all 0.3s ease;
      }

      .test-card:hover {
        border-color: #0ea5e9;
        transform: translateY(-2px);
      }

      .test-card h3 {
        color: #1e293b;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #ef4444;
        transition: background 0.3s ease;
      }

      .status-indicator.success {
        background: #10b981;
      }

      .status-indicator.warning {
        background: #f59e0b;
      }

      .test-result {
        margin: 10px 0;
        padding: 10px;
        border-radius: 6px;
        font-size: 0.9rem;
      }

      .test-result.success {
        background: #dcfce7;
        color: #166534;
        border: 1px solid #bbf7d0;
      }

      .test-result.error {
        background: #fef2f2;
        color: #991b1b;
        border: 1px solid #fecaca;
      }

      .test-result.warning {
        background: #fefce8;
        color: #92400e;
        border: 1px solid #fde68a;
      }

      .test-result.info {
        background: #eff6ff;
        color: #1e40af;
        border: 1px solid #bfdbfe;
      }

      .button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin: 30px 0;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        text-align: center;
      }

      .btn-primary {
        background: #0ea5e9;
        color: white;
      }

      .btn-primary:hover {
        background: #0284c7;
        transform: translateY(-1px);
      }

      .btn-success {
        background: #10b981;
        color: white;
      }

      .btn-success:hover {
        background: #059669;
      }

      .btn-warning {
        background: #f59e0b;
        color: white;
      }

      .btn-warning:hover {
        background: #d97706;
      }

      .btn-danger {
        background: #ef4444;
        color: white;
      }

      .btn-danger:hover {
        background: #dc2626;
      }

      .log-container {
        background: #1e293b;
        color: #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        max-height: 400px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 0.9rem;
      }

      .log-entry {
        margin-bottom: 8px;
        padding: 5px 0;
        border-bottom: 1px solid #334155;
      }

      .log-timestamp {
        color: #64748b;
        margin-right: 10px;
      }

      .log-success {
        color: #10b981;
      }

      .log-error {
        color: #ef4444;
      }

      .log-warning {
        color: #f59e0b;
      }

      .log-info {
        color: #0ea5e9;
      }

      .pwa-status {
        background: linear-gradient(135deg, #f8fafc, #e2e8f0);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
      }

      .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }

      .status-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background: white;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .offline-indicator {
        position: fixed;
        bottom: 80px;
        right: 16px;
        background: #f59e0b;
        color: white;
        padding: 4px 8px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        transform: translateX(100%);
        transition: transform 0.3s ease;
      }

      .offline-indicator.show {
        transform: translateX(0);
      }

      @media (max-width: 768px) {
        .container {
          margin: 10px;
          border-radius: 8px;
        }

        .header {
          padding: 20px;
        }

        .header h1 {
          font-size: 2rem;
        }

        .content {
          padding: 20px;
        }

        .test-grid {
          grid-template-columns: 1fr;
        }

        .button-group {
          flex-direction: column;
        }

        .btn {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="offline-indicator" id="offlineIndicator">
      <div style="display: flex; align-items: center; gap: 4px">
        <span>âš ï¸</span>
        <span>ç¦»çº¿æ¨¡å¼</span>
      </div>
    </div>

    <div class="container">
      <div class="header">
        <h1>ğŸš€ CloudPaste PWA æµ‹è¯•</h1>
        <p>Progressive Web App åŠŸèƒ½å®Œæ•´æµ‹è¯•é¡µé¢</p>
      </div>

      <div class="content">
        <!-- PWA çŠ¶æ€æ¦‚è§ˆ -->
        <div class="pwa-status">
          <h2>ğŸ“Š PWA çŠ¶æ€æ¦‚è§ˆ</h2>
          <div class="status-grid" id="statusGrid">
            <div class="status-item">
              <span>ç½‘ç»œçŠ¶æ€</span>
              <span id="networkStatus">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="status-item">
              <span>Service Worker</span>
              <span id="swStatus">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="status-item">
              <span>å¯å®‰è£…</span>
              <span id="installableStatus">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="status-item">
              <span>å·²å®‰è£…</span>
              <span id="installedStatus">æ£€æµ‹ä¸­...</span>
            </div>
          </div>
        </div>

        <!-- æµ‹è¯•é¡¹ç›® -->
        <div class="test-grid">
          <div class="test-card">
            <h3>
              <span class="status-indicator" id="manifestIndicator"></span>
              Web App Manifest
            </h3>
            <div id="manifestResult">æ­£åœ¨æ£€æµ‹...</div>
            <button class="btn btn-primary" onclick="testManifest()">æµ‹è¯• Manifest</button>
          </div>

          <div class="test-card">
            <h3>
              <span class="status-indicator" id="swIndicator"></span>
              Service Worker
            </h3>
            <div id="swResult">æ­£åœ¨æ£€æµ‹...</div>
            <button class="btn btn-primary" onclick="testServiceWorker()">æµ‹è¯• Service Worker</button>
          </div>

          <div class="test-card">
            <h3>
              <span class="status-indicator" id="cacheIndicator"></span>
              ç¼“å­˜åŠŸèƒ½
            </h3>
            <div id="cacheResult">æ­£åœ¨æ£€æµ‹...</div>
            <button class="btn btn-primary" onclick="testCache()">æµ‹è¯•ç¼“å­˜</button>
          </div>

          <div class="test-card">
            <h3>
              <span class="status-indicator" id="storageIndicator"></span>
              ç¦»çº¿å­˜å‚¨
            </h3>
            <div id="storageResult">æ­£åœ¨æ£€æµ‹...</div>
            <button class="btn btn-primary" onclick="testOfflineStorage()">æµ‹è¯•å­˜å‚¨</button>
          </div>

          <div class="test-card">
            <h3>
              <span class="status-indicator" id="installIndicator"></span>
              åº”ç”¨å®‰è£…
            </h3>
            <div id="installResult">æ­£åœ¨æ£€æµ‹...</div>
            <button class="btn btn-success" onclick="testInstall()" id="installBtn">æµ‹è¯•å®‰è£…</button>
          </div>

          <div class="test-card">
            <h3>
              <span class="status-indicator" id="notificationIndicator"></span>
              é€šçŸ¥æƒé™
            </h3>
            <div id="notificationResult">æ­£åœ¨æ£€æµ‹...</div>
            <button class="btn btn-primary" onclick="testNotifications()">æµ‹è¯•é€šçŸ¥</button>
          </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="button-group">
          <button class="btn btn-primary" onclick="runAllTests()">ğŸ”„ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
          <button class="btn btn-success" onclick="installPWA()" id="installPWABtn" style="display: none">ğŸ“± å®‰è£…åº”ç”¨</button>
          <button class="btn btn-warning" onclick="clearAllCaches()">ğŸ—‘ï¸ æ¸…ç†ç¼“å­˜</button>
          <button class="btn btn-warning" onclick="clearTestData()">ğŸ§¹ æ¸…ç†æµ‹è¯•æ•°æ®</button>
          <button class="btn btn-danger" onclick="unregisterSW()">âŒ æ³¨é”€ SW</button>
          <a href="/" class="btn btn-primary">ğŸ  è¿”å›ä¸»é¡µ</a>
        </div>

        <!-- æµ‹è¯•æ—¥å¿— -->
        <div>
          <h2>ğŸ“ æµ‹è¯•æ—¥å¿—</h2>
          <div class="log-container" id="logContainer">
            <div class="log-entry">
              <span class="log-timestamp">[åˆå§‹åŒ–]</span>
              <span class="log-info">PWA æµ‹è¯•é¡µé¢å·²åŠ è½½</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // å…¨å±€å˜é‡
      let deferredPrompt;
      let swRegistration;

      // æ—¥å¿—å‡½æ•°
      function addLog(message, type = "info") {
        const logContainer = document.getElementById("logContainer");
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement("div");
        logEntry.className = "log-entry";
        logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-${type}">${message}</span>
            `;
        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;
      }

      // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
      function updateIndicator(id, success) {
        const indicator = document.getElementById(id);
        if (indicator) {
          indicator.className = `status-indicator ${success ? "success" : "error"}`;
        }
      }

      // æ›´æ–°æµ‹è¯•ç»“æœ
      function updateResult(id, message, type = "info") {
        const result = document.getElementById(id);
        if (result) {
          result.innerHTML = `<div class="test-result ${type}">${message}</div>`;
        }
      }

      // ç½‘ç»œçŠ¶æ€ç›‘å¬
      function setupNetworkListeners() {
        const updateNetworkStatus = () => {
          const isOnline = navigator.onLine;
          document.getElementById("networkStatus").textContent = isOnline ? "åœ¨çº¿" : "ç¦»çº¿";
          document.getElementById("offlineIndicator").classList.toggle("show", !isOnline);
          addLog(`ç½‘ç»œçŠ¶æ€: ${isOnline ? "åœ¨çº¿" : "ç¦»çº¿"}`, isOnline ? "success" : "warning");
        };

        window.addEventListener("online", updateNetworkStatus);
        window.addEventListener("offline", updateNetworkStatus);
        updateNetworkStatus();
      }

      // æµ‹è¯• Manifest
      async function testManifest() {
        try {
          const response = await fetch("/manifest.json");
          if (response.ok) {
            const manifest = await response.json();
            updateIndicator("manifestIndicator", true);
            updateResult("manifestResult", `âœ… Manifest åŠ è½½æˆåŠŸ<br>åº”ç”¨åç§°: ${manifest.name}<br>å›¾æ ‡æ•°é‡: ${manifest.icons?.length || 0}`, "success");
            addLog("Manifest æµ‹è¯•é€šè¿‡", "success");
            return true;
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
        } catch (error) {
          updateIndicator("manifestIndicator", false);
          updateResult("manifestResult", `âŒ Manifest åŠ è½½å¤±è´¥: ${error.message}`, "error");
          addLog(`Manifest æµ‹è¯•å¤±è´¥: ${error.message}`, "error");
          return false;
        }
      }

      // æµ‹è¯• Service Worker
      async function testServiceWorker() {
        try {
          if ("serviceWorker" in navigator) {
            const registration = await navigator.serviceWorker.getRegistration();
            if (registration) {
              swRegistration = registration;
              updateIndicator("swIndicator", true);
              updateResult("swResult", `âœ… Service Worker å·²æ³¨å†Œ<br>çŠ¶æ€: ${registration.active ? "æ´»è·ƒ" : "æœªæ¿€æ´»"}<br>ä½œç”¨åŸŸ: ${registration.scope}`, "success");
              addLog("Service Worker æµ‹è¯•é€šè¿‡", "success");
              document.getElementById("swStatus").textContent = "å·²æ³¨å†Œ";
              return true;
            } else {
              updateIndicator("swIndicator", false);
              updateResult("swResult", "âš ï¸ Service Worker æœªæ³¨å†Œ", "warning");
              addLog("Service Worker æœªæ³¨å†Œ", "warning");
              document.getElementById("swStatus").textContent = "æœªæ³¨å†Œ";
              return false;
            }
          } else {
            updateIndicator("swIndicator", false);
            updateResult("swResult", "âŒ æµè§ˆå™¨ä¸æ”¯æŒ Service Worker", "error");
            addLog("æµè§ˆå™¨ä¸æ”¯æŒ Service Worker", "error");
            document.getElementById("swStatus").textContent = "ä¸æ”¯æŒ";
            return false;
          }
        } catch (error) {
          updateIndicator("swIndicator", false);
          updateResult("swResult", `âŒ Service Worker æµ‹è¯•å¤±è´¥: ${error.message}`, "error");
          addLog(`Service Worker æµ‹è¯•å¤±è´¥: ${error.message}`, "error");
          return false;
        }
      }

      // æµ‹è¯•ç¼“å­˜
      async function testCache() {
        try {
          if ("caches" in window) {
            const cacheNames = await caches.keys();
            const totalCaches = cacheNames.length;

            if (totalCaches > 0) {
              updateIndicator("cacheIndicator", true);
              updateResult(
                "cacheResult",
                `âœ… ç¼“å­˜åŠŸèƒ½æ­£å¸¸<br>ç¼“å­˜æ•°é‡: ${totalCaches}<br>ç¼“å­˜åç§°: ${cacheNames.slice(0, 3).join(", ")}${totalCaches > 3 ? "..." : ""}`,
                "success"
              );
              addLog(`å‘ç° ${totalCaches} ä¸ªç¼“å­˜`, "success");
              return true;
            } else {
              updateIndicator("cacheIndicator", false);
              updateResult("cacheResult", "âš ï¸ æœªå‘ç°ç¼“å­˜", "warning");
              addLog("æœªå‘ç°ç¼“å­˜", "warning");
              return false;
            }
          } else {
            updateIndicator("cacheIndicator", false);
            updateResult("cacheResult", "âŒ æµè§ˆå™¨ä¸æ”¯æŒ Cache API", "error");
            addLog("æµè§ˆå™¨ä¸æ”¯æŒ Cache API", "error");
            return false;
          }
        } catch (error) {
          updateIndicator("cacheIndicator", false);
          updateResult("cacheResult", `âŒ ç¼“å­˜æµ‹è¯•å¤±è´¥: ${error.message}`, "error");
          addLog(`ç¼“å­˜æµ‹è¯•å¤±è´¥: ${error.message}`, "error");
          return false;
        }
      }

      // æµ‹è¯•ç¦»çº¿å­˜å‚¨
      async function testOfflineStorage() {
        // é¦–å…ˆæµ‹è¯• localStorage ä½œä¸ºåŸºç¡€å­˜å‚¨
        try {
          const testKey = "pwa_test_" + Date.now();
          const testValue = "PWAæµ‹è¯•æ•°æ®";

          localStorage.setItem(testKey, testValue);
          const retrievedValue = localStorage.getItem(testKey);
          localStorage.removeItem(testKey);

          if (retrievedValue === testValue) {
            addLog("localStorage æµ‹è¯•é€šè¿‡", "success");
          } else {
            addLog("localStorage æµ‹è¯•å¤±è´¥", "warning");
          }
        } catch (error) {
          addLog(`localStorage æµ‹è¯•å¤±è´¥: ${error.message}`, "warning");
        }

        // ç„¶åæµ‹è¯• IndexedDB
        return new Promise((resolve) => {
          try {
            if ("indexedDB" in window) {
              // æµ‹è¯• IndexedDB
              const testData = { key: "test", value: "PWAæµ‹è¯•æ•°æ®", timestamp: Date.now() };

              const request = indexedDB.open("PWATestDB", 1);

              request.onupgradeneeded = (event) => {
                const db = event.target.result;
                // åˆ é™¤æ—§çš„å­˜å‚¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (db.objectStoreNames.contains("testStore")) {
                  db.deleteObjectStore("testStore");
                }
                // åˆ›å»ºæ–°çš„å­˜å‚¨
                db.createObjectStore("testStore", { keyPath: "key" });
                addLog("IndexedDB æ•°æ®åº“å‡çº§å®Œæˆ", "info");
              };

              request.onsuccess = (event) => {
                const db = event.target.result;

                try {
                  const transaction = db.transaction(["testStore"], "readwrite");
                  const store = transaction.objectStore("testStore");

                  // å†™å…¥æ•°æ®
                  const putRequest = store.put(testData);

                  putRequest.onsuccess = () => {
                    // è¯»å–æ•°æ®
                    const getRequest = store.get("test");

                    getRequest.onsuccess = () => {
                      const result = getRequest.result;

                      addLog(`IndexedDB è¯»å–ç»“æœ: ${JSON.stringify(result)}`, "info");
                      addLog(`æœŸæœ›æ•°æ®: ${JSON.stringify(testData)}`, "info");

                      if (result && result.value === testData.value) {
                        updateIndicator("storageIndicator", true);
                        updateResult("storageResult", "âœ… ç¦»çº¿å­˜å‚¨åŠŸèƒ½æ­£å¸¸<br>localStorage: é€šè¿‡<br>IndexedDB: é€šè¿‡<br>å­˜å‚¨æ•°æ®: " + result.value, "success");
                        addLog("IndexedDB æµ‹è¯•é€šè¿‡", "success");
                        db.close();
                        resolve(true);
                      } else {
                        updateIndicator("storageIndicator", false);
                        updateResult(
                          "storageResult",
                          `âŒ IndexedDB æ•°æ®è¯»å†™ä¸åŒ¹é…<br>æœŸæœ›: ${testData.value}<br>å®é™…: ${result ? result.value : "null"}<br>localStorage: é€šè¿‡`,
                          "error"
                        );
                        addLog(`IndexedDB æ•°æ®ä¸åŒ¹é… - æœŸæœ›: ${testData.value}, å®é™…: ${result ? result.value : "null"}`, "error");
                        db.close();
                        resolve(false);
                      }
                    };

                    getRequest.onerror = () => {
                      updateIndicator("storageIndicator", false);
                      updateResult("storageResult", "âŒ æ•°æ®è¯»å–å¤±è´¥", "error");
                      addLog("æ•°æ®è¯»å–å¤±è´¥", "error");
                      db.close();
                      resolve(false);
                    };
                  };

                  putRequest.onerror = () => {
                    updateIndicator("storageIndicator", false);
                    updateResult("storageResult", "âŒ æ•°æ®å†™å…¥å¤±è´¥", "error");
                    addLog("æ•°æ®å†™å…¥å¤±è´¥", "error");
                    db.close();
                    resolve(false);
                  };
                } catch (error) {
                  updateIndicator("storageIndicator", false);
                  updateResult("storageResult", `âŒ äº‹åŠ¡æ“ä½œå¤±è´¥: ${error.message}`, "error");
                  addLog(`äº‹åŠ¡æ“ä½œå¤±è´¥: ${error.message}`, "error");
                  db.close();
                  resolve(false);
                }
              };

              request.onerror = () => {
                updateIndicator("storageIndicator", false);
                updateResult("storageResult", "âŒ IndexedDB æ‰“å¼€å¤±è´¥", "error");
                addLog("IndexedDB æ‰“å¼€å¤±è´¥", "error");
                resolve(false);
              };
            } else {
              updateIndicator("storageIndicator", false);
              updateResult("storageResult", "âŒ æµè§ˆå™¨ä¸æ”¯æŒ IndexedDB", "error");
              addLog("æµè§ˆå™¨ä¸æ”¯æŒ IndexedDB", "error");
              resolve(false);
            }
          } catch (error) {
            updateIndicator("storageIndicator", false);
            updateResult("storageResult", `âŒ ç¦»çº¿å­˜å‚¨æµ‹è¯•å¤±è´¥: ${error.message}`, "error");
            addLog(`ç¦»çº¿å­˜å‚¨æµ‹è¯•å¤±è´¥: ${error.message}`, "error");
            resolve(false);
          }
        });
      }

      // æµ‹è¯•å®‰è£…åŠŸèƒ½
      function testInstall() {
        if (deferredPrompt) {
          updateIndicator("installIndicator", true);
          updateResult("installResult", 'âœ… åº”ç”¨å¯ä»¥å®‰è£…<br>ç‚¹å‡»"å®‰è£…åº”ç”¨"æŒ‰é’®è¿›è¡Œå®‰è£…', "success");
          document.getElementById("installPWABtn").style.display = "inline-block";
          addLog("åº”ç”¨å¯ä»¥å®‰è£…", "success");
          document.getElementById("installableStatus").textContent = "æ˜¯";
          return true;
        } else if (window.matchMedia("(display-mode: standalone)").matches) {
          updateIndicator("installIndicator", true);
          updateResult("installResult", "âœ… åº”ç”¨å·²å®‰è£…<br>å½“å‰è¿è¡Œåœ¨ç‹¬ç«‹æ¨¡å¼", "success");
          addLog("åº”ç”¨å·²å®‰è£…", "success");
          document.getElementById("installedStatus").textContent = "æ˜¯";
          return true;
        } else {
          updateIndicator("installIndicator", false);
          updateResult("installResult", "âš ï¸ åº”ç”¨æš‚æ—¶æ— æ³•å®‰è£…<br>å¯èƒ½éœ€è¦æ»¡è¶³æ›´å¤š PWA æ¡ä»¶", "warning");
          addLog("åº”ç”¨æš‚æ—¶æ— æ³•å®‰è£…", "warning");
          document.getElementById("installableStatus").textContent = "å¦";
          return false;
        }
      }

      // æµ‹è¯•é€šçŸ¥
      async function testNotifications() {
        try {
          if ("Notification" in window) {
            const permission = await Notification.requestPermission();
            if (permission === "granted") {
              updateIndicator("notificationIndicator", true);
              updateResult("notificationResult", "âœ… é€šçŸ¥æƒé™å·²æˆäºˆ", "success");
              addLog("é€šçŸ¥æƒé™å·²æˆäºˆ", "success");

              // å‘é€æµ‹è¯•é€šçŸ¥
              new Notification("CloudPaste PWA", {
                body: "é€šçŸ¥åŠŸèƒ½æµ‹è¯•æˆåŠŸï¼",
                icon: "/icons/icon-96.png",
              });

              return true;
            } else {
              updateIndicator("notificationIndicator", false);
              updateResult("notificationResult", "âš ï¸ é€šçŸ¥æƒé™è¢«æ‹’ç»", "warning");
              addLog("é€šçŸ¥æƒé™è¢«æ‹’ç»", "warning");
              return false;
            }
          } else {
            updateIndicator("notificationIndicator", false);
            updateResult("notificationResult", "âŒ æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥", "error");
            addLog("æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥", "error");
            return false;
          }
        } catch (error) {
          updateIndicator("notificationIndicator", false);
          updateResult("notificationResult", `âŒ é€šçŸ¥æµ‹è¯•å¤±è´¥: ${error.message}`, "error");
          addLog(`é€šçŸ¥æµ‹è¯•å¤±è´¥: ${error.message}`, "error");
          return false;
        }
      }

      // è¿è¡Œæ‰€æœ‰æµ‹è¯•
      async function runAllTests() {
        addLog("å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...", "info");

        const tests = [testManifest, testServiceWorker, testCache, testOfflineStorage, testInstall, testNotifications];

        let passedTests = 0;
        for (const test of tests) {
          try {
            const result = await test();
            if (result) passedTests++;
          } catch (error) {
            addLog(`æµ‹è¯•æ‰§è¡Œé”™è¯¯: ${error.message}`, "error");
          }
          // æ·»åŠ å»¶è¿Ÿä»¥ä¾¿è§‚å¯Ÿæµ‹è¯•è¿‡ç¨‹
          await new Promise((resolve) => setTimeout(resolve, 500));
        }

        addLog(`æ‰€æœ‰æµ‹è¯•å®Œæˆï¼é€šè¿‡ ${passedTests}/${tests.length} é¡¹æµ‹è¯•`, passedTests === tests.length ? "success" : "warning");
      }

      // å®‰è£… PWA
      async function installPWA() {
        if (deferredPrompt) {
          try {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;

            if (outcome === "accepted") {
              addLog("ç”¨æˆ·æ¥å—äº†å®‰è£…", "success");
              document.getElementById("installPWABtn").style.display = "none";
              document.getElementById("installedStatus").textContent = "æ˜¯";
            } else {
              addLog("ç”¨æˆ·æ‹’ç»äº†å®‰è£…", "warning");
            }

            deferredPrompt = null;
          } catch (error) {
            addLog(`å®‰è£…å¤±è´¥: ${error.message}`, "error");
          }
        } else {
          addLog("æ— æ³•å®‰è£…ï¼šæ²¡æœ‰å®‰è£…æç¤º", "warning");
        }
      }

      // æ¸…ç†æ‰€æœ‰ç¼“å­˜
      async function clearAllCaches() {
        try {
          if ("caches" in window) {
            const cacheNames = await caches.keys();
            await Promise.all(cacheNames.map((name) => caches.delete(name)));
            addLog(`å·²æ¸…ç† ${cacheNames.length} ä¸ªç¼“å­˜`, "success");

            // é‡æ–°æµ‹è¯•ç¼“å­˜
            setTimeout(testCache, 1000);
          } else {
            addLog("æµè§ˆå™¨ä¸æ”¯æŒç¼“å­˜æ¸…ç†", "error");
          }
        } catch (error) {
          addLog(`æ¸…ç†ç¼“å­˜å¤±è´¥: ${error.message}`, "error");
        }
      }

      // æ³¨é”€ Service Worker
      async function unregisterSW() {
        try {
          if ("serviceWorker" in navigator) {
            const registrations = await navigator.serviceWorker.getRegistrations();
            for (const registration of registrations) {
              await registration.unregister();
            }
            addLog(`å·²æ³¨é”€ ${registrations.length} ä¸ª Service Worker`, "success");
            document.getElementById("swStatus").textContent = "å·²æ³¨é”€";

            // é‡æ–°æµ‹è¯• Service Worker
            setTimeout(testServiceWorker, 1000);
          } else {
            addLog("æµè§ˆå™¨ä¸æ”¯æŒ Service Worker", "error");
          }
        } catch (error) {
          addLog(`æ³¨é”€ Service Worker å¤±è´¥: ${error.message}`, "error");
        }
      }

      // æ¸…ç†æµ‹è¯•æ•°æ®
      async function clearTestData() {
        try {
          // æ¸…ç† localStorage æµ‹è¯•æ•°æ®
          const keys = Object.keys(localStorage);
          const testKeys = keys.filter((key) => key.startsWith("pwa_test_"));
          testKeys.forEach((key) => localStorage.removeItem(key));

          // æ¸…ç† IndexedDB æµ‹è¯•æ•°æ®
          if ("indexedDB" in window) {
            const deleteRequest = indexedDB.deleteDatabase("PWATestDB");
            deleteRequest.onsuccess = () => {
              addLog("IndexedDB æµ‹è¯•æ•°æ®åº“å·²åˆ é™¤", "success");
            };
            deleteRequest.onerror = () => {
              addLog("åˆ é™¤ IndexedDB æµ‹è¯•æ•°æ®åº“å¤±è´¥", "warning");
            };
          }

          addLog(`å·²æ¸…ç† ${testKeys.length} ä¸ª localStorage æµ‹è¯•é¡¹`, "success");

          // é‡æ–°æµ‹è¯•å­˜å‚¨
          setTimeout(testOfflineStorage, 1000);
        } catch (error) {
          addLog(`æ¸…ç†æµ‹è¯•æ•°æ®å¤±è´¥: ${error.message}`, "error");
        }
      }

      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
      window.addEventListener("load", () => {
        addLog("é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...", "info");

        // è®¾ç½®ç½‘ç»œçŠ¶æ€ç›‘å¬
        setupNetworkListeners();

        // ç›‘å¬å®‰è£…æç¤º
        window.addEventListener("beforeinstallprompt", (e) => {
          e.preventDefault();
          deferredPrompt = e;
          addLog("æ£€æµ‹åˆ°å®‰è£…æç¤º", "success");
          document.getElementById("installPWABtn").style.display = "inline-block";
        });

        // ç›‘å¬åº”ç”¨å®‰è£…
        window.addEventListener("appinstalled", () => {
          addLog("åº”ç”¨å·²æˆåŠŸå®‰è£…", "success");
          document.getElementById("installedStatus").textContent = "æ˜¯";
          document.getElementById("installPWABtn").style.display = "none";
        });

        // æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
        if (window.matchMedia("(display-mode: standalone)").matches) {
          document.getElementById("installedStatus").textContent = "æ˜¯";
          addLog("æ£€æµ‹åˆ°åº”ç”¨å·²å®‰è£…ï¼ˆç‹¬ç«‹æ¨¡å¼ï¼‰", "success");
        }

        // è‡ªåŠ¨è¿è¡Œæµ‹è¯•
        setTimeout(runAllTests, 1000);
      });
    </script>
  </body>
</html>
