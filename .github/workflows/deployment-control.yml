name: ğŸ›ï¸ éƒ¨ç½²æ§åˆ¶é¢æ¿[â­Click ME] / Deployment Control Panel

on:
  workflow_dispatch:
    inputs:
      spa_deploy:
        description: 'ğŸ”„ SPAä¸€ä½“åŒ–è‡ªåŠ¨éƒ¨ç½² / SPA unified auto deploy'
        required: true
        type: choice
        options:
          - 'ğŸŸ¢ å¼€å¯'
          - 'ğŸ”´ å…³é—­'
          - 'ğŸ“Š æŸ¥çœ‹å½“å‰çŠ¶æ€'
        default: 'ğŸ“Š æŸ¥çœ‹å½“å‰çŠ¶æ€'

      backend_deploy:
        description: 'âš™ï¸ åç«¯åˆ†ç¦»è‡ªåŠ¨éƒ¨ç½² / Backend-only auto deploy'
        required: true
        type: choice
        options:
          - 'ğŸŸ¢ å¼€å¯'
          - 'ğŸ”´ å…³é—­'
          - 'ğŸ“Š æŸ¥çœ‹å½“å‰çŠ¶æ€'
        default: 'ğŸ“Š æŸ¥çœ‹å½“å‰çŠ¶æ€'

      frontend_deploy:
        description: 'ğŸ¨ å‰ç«¯åˆ†ç¦»è‡ªåŠ¨éƒ¨ç½² / Frontend-only auto deploy'
        required: true
        type: choice
        options:
          - 'ğŸŸ¢ å¼€å¯'
          - 'ğŸ”´ å…³é—­'
          - 'ğŸ“Š æŸ¥çœ‹å½“å‰çŠ¶æ€'
        default: 'ğŸ“Š æŸ¥çœ‹å½“å‰çŠ¶æ€'

jobs:
  control-deployments:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“‹ è¯»å–å½“å‰é…ç½®çŠ¶æ€
        id: read_config
        run: |
          SPA_STATUS="${{ vars.SPA_DEPLOY }}"
          BACKEND_STATUS="${{ vars.BACKEND_DEPLOY }}"
          FRONTEND_STATUS="${{ vars.FRONTEND_DEPLOY }}"
          LAST_UPDATED="${{ vars.DEPLOY_LAST_UPDATED }}"
          UPDATED_BY="${{ vars.DEPLOY_UPDATED_BY }}"

          # å˜é‡æœªè®¾ç½®æ—¶ä½¿ç”¨é»˜è®¤å€¼
          [ -z "$SPA_STATUS" ] && SPA_STATUS="false"
          [ -z "$BACKEND_STATUS" ] && BACKEND_STATUS="false"
          [ -z "$FRONTEND_STATUS" ] && FRONTEND_STATUS="false"
          [ -z "$LAST_UPDATED" ] && LAST_UPDATED="N/A"
          [ -z "$UPDATED_BY" ] && UPDATED_BY="N/A"

          echo "spa_status=$SPA_STATUS" >> $GITHUB_OUTPUT
          echo "backend_status=$BACKEND_STATUS" >> $GITHUB_OUTPUT
          echo "frontend_status=$FRONTEND_STATUS" >> $GITHUB_OUTPUT
          echo "last_updated=$LAST_UPDATED" >> $GITHUB_OUTPUT
          echo "updated_by=$UPDATED_BY" >> $GITHUB_OUTPUT

          echo "======================================"
          echo "ğŸ“Š å½“å‰è‡ªåŠ¨éƒ¨ç½²çŠ¶æ€"
          echo "ğŸ“Š Current auto deployment status"
          echo "======================================"
          echo ""
          echo "ğŸ”„ SPAä¸€ä½“åŒ–éƒ¨ç½² / SPA unified: $([ "$SPA_STATUS" = "true" ] && echo 'ğŸŸ¢ å·²å¼€å¯ / ON' || echo 'ğŸ”´ å·²å…³é—­ / OFF')"
          echo "âš™ï¸ åç«¯åˆ†ç¦»éƒ¨ç½² / Backend only: $([ "$BACKEND_STATUS" = "true" ] && echo 'ğŸŸ¢ å·²å¼€å¯ / ON' || echo 'ğŸ”´ å·²å…³é—­ / OFF')"
          echo "ğŸ¨ å‰ç«¯åˆ†ç¦»éƒ¨ç½² / Frontend only: $([ "$FRONTEND_STATUS" = "true" ] && echo 'ğŸŸ¢ å·²å¼€å¯ / ON' || echo 'ğŸ”´ å·²å…³é—­ / OFF')"
          echo ""
          echo "ğŸ“… æœ€åæ›´æ–° / Last updated: $LAST_UPDATED"
          echo "ğŸ‘¤ æ›´æ–°è€… / Updated by: $UPDATED_BY"
          echo ""
          echo "======================================"

      - name: ğŸ”„ æ›´æ–° SPA ä¸€ä½“åŒ–éƒ¨ç½²é…ç½®
        if: github.event.inputs.spa_deploy != 'ğŸ“Š æŸ¥çœ‹å½“å‰çŠ¶æ€'
        run: |
          ACTOR="${{ github.actor }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          if [[ "${{ github.event.inputs.spa_deploy }}" == "ğŸŸ¢ å¼€å¯" ]]; then
            echo "âœ… æ­£åœ¨å¼€å¯ SPA ä¸€ä½“åŒ–è‡ªåŠ¨éƒ¨ç½² / Enabling SPA unified auto deploy..."
            NEW_VALUE="true"
            echo "ğŸ‰ SPA ä¸€ä½“åŒ–è‡ªåŠ¨éƒ¨ç½²å·²å¼€å¯ / SPA unified auto deploy is ON!"
          else
            echo "â¸ï¸ æ­£åœ¨å…³é—­ SPA ä¸€ä½“åŒ–è‡ªåŠ¨éƒ¨ç½² / Disabling SPA unified auto deploy..."
            NEW_VALUE="false"
            echo "âœ… SPA ä¸€ä½“åŒ–è‡ªåŠ¨éƒ¨ç½²å·²å…³é—­ / SPA unified auto deploy is OFF!"
          fi

          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          # æ›´æ–°ä»“åº“çº§ Actions å˜é‡ï¼ˆä¸å­˜åœ¨æ—¶è‡ªåŠ¨åˆ›å»ºï¼‰
          for VAR_NAME in SPA_DEPLOY DEPLOY_LAST_UPDATED DEPLOY_UPDATED_BY; do
            case "$VAR_NAME" in
              SPA_DEPLOY)
                VAR_VALUE="$NEW_VALUE"
                ;;
              DEPLOY_LAST_UPDATED)
                VAR_VALUE="$TIMESTAMP"
                ;;
              DEPLOY_UPDATED_BY)
                VAR_VALUE="$ACTOR"
                ;;
            esac

            HTTP_CODE=$(curl -sS -o /tmp/var_resp.json -w "%{http_code}" \
              -X PATCH \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.ACTIONS_VAR_TOKEN }}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/$OWNER/$REPO/actions/variables/$VAR_NAME" \
              -d "{\"name\":\"$VAR_NAME\",\"value\":\"$VAR_VALUE\"}")

            if [ "$HTTP_CODE" = "404" ]; then
              HTTP_CODE=$(curl -sS -o /tmp/var_resp.json -w "%{http_code}" \
                -X POST \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer ${{ secrets.ACTIONS_VAR_TOKEN }}" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "https://api.github.com/repos/$OWNER/$REPO/actions/variables" \
                -d "{\"name\":\"$VAR_NAME\",\"value\":\"$VAR_VALUE\"}")
            fi

            if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
              echo "âŒ æ›´æ–°å˜é‡ $VAR_NAME å¤±è´¥ï¼ŒHTTP çŠ¶æ€ç : $HTTP_CODE"
              cat /tmp/var_resp.json || true
              exit 1
            fi
          done

          # è§¦å‘ SPA ä¸€ä½“åŒ–éƒ¨ç½²å·¥ä½œæµï¼ˆæ ¹æ®å½“å‰å¼€å…³çŠ¶æ€ç”±ç›®æ ‡å·¥ä½œæµè‡ªè¡Œå†³å®šæ˜¯å¦æ‰§è¡Œï¼‰
          DISPATCH_CODE=$(curl -sS -o /tmp/spa_dispatch.json -w "%{http_code}" \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.ACTIONS_VAR_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/$OWNER/$REPO/actions/workflows/deploy-spa-cloudflare.yml/dispatches" \
            -d "{\"ref\":\"${{ github.ref_name }}\",\"inputs\":{\"from_panel\":\"true\"}}")

          if [ "$DISPATCH_CODE" -ge 200 ] && [ "$DISPATCH_CODE" -lt 300 ]; then
            echo "ğŸš€ å·²è§¦å‘ SPA ä¸€ä½“åŒ–éƒ¨ç½²å·¥ä½œæµï¼ˆå°†æŒ‰å½“å‰ SPA_DEPLOY å¼€å…³å†³å®šæ˜¯å¦çœŸæ­£éƒ¨ç½²ï¼‰"
          else
            echo "âš ï¸ è§¦å‘ SPA ä¸€ä½“åŒ–éƒ¨ç½²å·¥ä½œæµå¤±è´¥ï¼ŒHTTP çŠ¶æ€ç : $DISPATCH_CODE"
            cat /tmp/spa_dispatch.json || true
          fi

      - name: âš™ï¸ æ›´æ–°åç«¯åˆ†ç¦»éƒ¨ç½²é…ç½®
        if: github.event.inputs.backend_deploy != 'ğŸ“Š æŸ¥çœ‹å½“å‰çŠ¶æ€'
        run: |
          ACTOR="${{ github.actor }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          if [[ "${{ github.event.inputs.backend_deploy }}" == "ğŸŸ¢ å¼€å¯" ]]; then
            echo "âœ… æ­£åœ¨å¼€å¯åç«¯åˆ†ç¦»è‡ªåŠ¨éƒ¨ç½² / Enabling backend-only auto deploy..."
            NEW_VALUE="true"
            echo "ğŸ‰ åç«¯åˆ†ç¦»è‡ªåŠ¨éƒ¨ç½²å·²å¼€å¯ / Backend-only auto deploy is ON!"
          else
            echo "â¸ï¸ æ­£åœ¨å…³é—­åç«¯åˆ†ç¦»è‡ªåŠ¨éƒ¨ç½² / Disabling backend-only auto deploy..."
            NEW_VALUE="false"
            echo "âœ… åç«¯åˆ†ç¦»è‡ªåŠ¨éƒ¨ç½²å·²å…³é—­ / Backend-only auto deploy is OFF!"
          fi

          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          for VAR_NAME in BACKEND_DEPLOY DEPLOY_LAST_UPDATED DEPLOY_UPDATED_BY; do
            case "$VAR_NAME" in
              BACKEND_DEPLOY)
                VAR_VALUE="$NEW_VALUE"
                ;;
              DEPLOY_LAST_UPDATED)
                VAR_VALUE="$TIMESTAMP"
                ;;
              DEPLOY_UPDATED_BY)
                VAR_VALUE="$ACTOR"
                ;;
            esac

            HTTP_CODE=$(curl -sS -o /tmp/var_resp.json -w "%{http_code}" \
              -X PATCH \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.ACTIONS_VAR_TOKEN }}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/$OWNER/$REPO/actions/variables/$VAR_NAME" \
              -d "{\"name\":\"$VAR_NAME\",\"value\":\"$VAR_VALUE\"}")

            if [ "$HTTP_CODE" = "404" ]; then
              HTTP_CODE=$(curl -sS -o /tmp/var_resp.json -w "%{http_code}" \
                -X POST \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer ${{ secrets.ACTIONS_VAR_TOKEN }}" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "https://api.github.com/repos/$OWNER/$REPO/actions/variables" \
                -d "{\"name\":\"$VAR_NAME\",\"value\":\"$VAR_VALUE\"}")
            fi

            if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
              echo "âŒ æ›´æ–°å˜é‡ $VAR_NAME å¤±è´¥ï¼ŒHTTP çŠ¶æ€ç : $HTTP_CODE"
              cat /tmp/var_resp.json || true
              exit 1
            fi
          done

          # è§¦å‘åç«¯åˆ†ç¦»éƒ¨ç½²å·¥ä½œæµï¼ˆæ ¹æ®å½“å‰å¼€å…³çŠ¶æ€ç”±ç›®æ ‡å·¥ä½œæµè‡ªè¡Œå†³å®šæ˜¯å¦æ‰§è¡Œï¼‰
          DISPATCH_CODE=$(curl -sS -o /tmp/backend_dispatch.json -w "%{http_code}" \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.ACTIONS_VAR_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/$OWNER/$REPO/actions/workflows/deploy-backend-cloudflare.yml/dispatches" \
            -d "{\"ref\":\"${{ github.ref_name }}\",\"inputs\":{\"from_panel\":\"true\"}}")

          if [ "$DISPATCH_CODE" -ge 200 ] && [ "$DISPATCH_CODE" -lt 300 ]; then
            echo "ğŸš€ å·²è§¦å‘åç«¯åˆ†ç¦»éƒ¨ç½²å·¥ä½œæµï¼ˆå°†æŒ‰å½“å‰ BACKEND_DEPLOY å¼€å…³å†³å®šæ˜¯å¦çœŸæ­£éƒ¨ç½²ï¼‰"
          else
            echo "âš ï¸ è§¦å‘åç«¯åˆ†ç¦»éƒ¨ç½²å·¥ä½œæµå¤±è´¥ï¼ŒHTTP çŠ¶æ€ç : $DISPATCH_CODE"
            cat /tmp/backend_dispatch.json || true
          fi

      - name: ğŸ¨ æ›´æ–°å‰ç«¯åˆ†ç¦»éƒ¨ç½²é…ç½®
        if: github.event.inputs.frontend_deploy != 'ğŸ“Š æŸ¥çœ‹å½“å‰çŠ¶æ€'
        run: |
          ACTOR="${{ github.actor }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          if [[ "${{ github.event.inputs.frontend_deploy }}" == "ğŸŸ¢ å¼€å¯" ]]; then
            echo "âœ… æ­£åœ¨å¼€å¯å‰ç«¯åˆ†ç¦»è‡ªåŠ¨éƒ¨ç½² / Enabling frontend-only auto deploy..."
            NEW_VALUE="true"
            echo "ğŸ‰ å‰ç«¯åˆ†ç¦»è‡ªåŠ¨éƒ¨ç½²å·²å¼€å¯ / Frontend-only auto deploy is ON!"
          else
            echo "â¸ï¸ æ­£åœ¨å…³é—­å‰ç«¯åˆ†ç¦»è‡ªåŠ¨éƒ¨ç½² / Disabling frontend-only auto deploy..."
            NEW_VALUE="false"
            echo "âœ… å‰ç«¯åˆ†ç¦»è‡ªåŠ¨éƒ¨ç½²å·²å…³é—­ / Frontend-only auto deploy is OFF!"
          fi

          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          for VAR_NAME in FRONTEND_DEPLOY DEPLOY_LAST_UPDATED DEPLOY_UPDATED_BY; do
            case "$VAR_NAME" in
              FRONTEND_DEPLOY)
                VAR_VALUE="$NEW_VALUE"
                ;;
              DEPLOY_LAST_UPDATED)
                VAR_VALUE="$TIMESTAMP"
                ;;
              DEPLOY_UPDATED_BY)
                VAR_VALUE="$ACTOR"
                ;;
            esac

            HTTP_CODE=$(curl -sS -o /tmp/var_resp.json -w "%{http_code}" \
              -X PATCH \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.ACTIONS_VAR_TOKEN }}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/$OWNER/$REPO/actions/variables/$VAR_NAME" \
              -d "{\"name\":\"$VAR_NAME\",\"value\":\"$VAR_VALUE\"}")

            if [ "$HTTP_CODE" = "404" ]; then
              HTTP_CODE=$(curl -sS -o /tmp/var_resp.json -w "%{http_code}" \
                -X POST \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer ${{ secrets.ACTIONS_VAR_TOKEN }}" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "https://api.github.com/repos/$OWNER/$REPO/actions/variables" \
                -d "{\"name\":\"$VAR_NAME\",\"value\":\"$VAR_VALUE\"}")
            fi

            if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
              echo "âŒ æ›´æ–°å˜é‡ $VAR_NAME å¤±è´¥ï¼ŒHTTP çŠ¶æ€ç : $HTTP_CODE"
              cat /tmp/var_resp.json || true
              exit 1
            fi
          done

          # è§¦å‘å‰ç«¯åˆ†ç¦»éƒ¨ç½²å·¥ä½œæµï¼ˆæ ¹æ®å½“å‰å¼€å…³çŠ¶æ€ç”±ç›®æ ‡å·¥ä½œæµè‡ªè¡Œå†³å®šæ˜¯å¦æ‰§è¡Œï¼‰
          DISPATCH_CODE=$(curl -sS -o /tmp/frontend_dispatch.json -w "%{http_code}" \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.ACTIONS_VAR_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/$OWNER/$REPO/actions/workflows/deploy-frontend-cloudflare.yml/dispatches" \
            -d "{\"ref\":\"${{ github.ref_name }}\",\"inputs\":{\"from_panel\":\"true\"}}")

          if [ "$DISPATCH_CODE" -ge 200 ] && [ "$DISPATCH_CODE" -lt 300 ]; then
            echo "ğŸš€ å·²è§¦å‘å‰ç«¯åˆ†ç¦»éƒ¨ç½²å·¥ä½œæµï¼ˆå°†æŒ‰å½“å‰ FRONTEND_DEPLOY å¼€å…³å†³å®šæ˜¯å¦çœŸæ­£éƒ¨ç½²ï¼‰"
          else
            echo "âš ï¸ è§¦å‘å‰ç«¯åˆ†ç¦»éƒ¨ç½²å·¥ä½œæµå¤±è´¥ï¼ŒHTTP çŠ¶æ€ç : $DISPATCH_CODE"
            cat /tmp/frontend_dispatch.json || true
          fi

      - name: ğŸ“Š æ˜¾ç¤ºæ›´æ–°åçš„çŠ¶æ€
        run: |
          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          fetch_var() {
            local name="$1"
            curl -sS \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.ACTIONS_VAR_TOKEN }}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/$OWNER/$REPO/actions/variables/$name" \
              | jq -r '.value // empty'
          }

          NEW_SPA_STATUS=$(fetch_var "SPA_DEPLOY")
          NEW_BACKEND_STATUS=$(fetch_var "BACKEND_DEPLOY")
          NEW_FRONTEND_STATUS=$(fetch_var "FRONTEND_DEPLOY")
          LAST_UPDATED=$(fetch_var "DEPLOY_LAST_UPDATED")
          UPDATED_BY=$(fetch_var "DEPLOY_UPDATED_BY")

          [ -z "$NEW_SPA_STATUS" ] && NEW_SPA_STATUS="false"
          [ -z "$NEW_BACKEND_STATUS" ] && NEW_BACKEND_STATUS="false"
          [ -z "$NEW_FRONTEND_STATUS" ] && NEW_FRONTEND_STATUS="false"
          [ -z "$LAST_UPDATED" ] && LAST_UPDATED="N/A"
          [ -z "$UPDATED_BY" ] && UPDATED_BY="N/A"

          echo ""
          echo "======================================"
          echo "âœ… é…ç½®æ›´æ–°å®Œæˆ / Config update completed"
          echo "======================================"
          echo ""
          echo "ğŸ”„ SPAä¸€ä½“åŒ–éƒ¨ç½² / SPA unified: $([ "$NEW_SPA_STATUS" = "true" ] && echo 'ğŸŸ¢ å·²å¼€å¯ / ON' || echo 'ğŸ”´ å·²å…³é—­ / OFF')"
          echo "âš™ï¸ åç«¯åˆ†ç¦»éƒ¨ç½² / Backend only: $([ "$NEW_BACKEND_STATUS" = "true" ] && echo 'ğŸŸ¢ å·²å¼€å¯ / ON' || echo 'ğŸ”´ å·²å…³é—­ / OFF')"
          echo "ğŸ¨ å‰ç«¯åˆ†ç¦»éƒ¨ç½² / Frontend only: $([ "$NEW_FRONTEND_STATUS" = "true" ] && echo 'ğŸŸ¢ å·²å¼€å¯ / ON' || echo 'ğŸ”´ å·²å…³é—­ / OFF')"
          echo ""
          echo "ğŸ“… æœ€åæ›´æ–° / Last updated: $LAST_UPDATED"
          echo "ğŸ‘¤ æ›´æ–°è€… / Updated by: $UPDATED_BY"
          echo ""
          echo "======================================"

          # æ£€æµ‹å¤šé‡éƒ¨ç½²è­¦å‘Š
          ENABLED_COUNT=0
          [ "$NEW_SPA_STATUS" = "true" ] && ((ENABLED_COUNT++)) || true
          [ "$NEW_BACKEND_STATUS" = "true" ] && ((ENABLED_COUNT++)) || true
          [ "$NEW_FRONTEND_STATUS" = "true" ] && ((ENABLED_COUNT++)) || true

          if [ $ENABLED_COUNT -gt 1 ]; then
            echo ""
            echo "âš ï¸ è­¦å‘Šï¼šæ£€æµ‹åˆ°å¤šä¸ªéƒ¨ç½²æ–¹å¼åŒæ—¶å¯ç”¨ï¼ / Warning: multiple deployment modes are enabled at the same time!"
            echo "å»ºè®®åªå¯ç”¨ä¸€ç§éƒ¨ç½²æ–¹å¼ä»¥é¿å…é‡å¤éƒ¨ç½²ã€‚ / It is recommended to enable only one mode to avoid duplicate deployments."
            echo ""
          fi
