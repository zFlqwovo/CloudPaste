name: Deploy SPA CF Workers[ä¸€ä½“åŒ–éƒ¨ç½²]

on:
  push:
    branches: [main, master]
    paths:
      - "frontend/**"
      - "backend/**"
      - "!frontend/vercel.json"
  workflow_dispatch:
    inputs:
      from_panel:
        description: "æ˜¯å¦ç”±éƒ¨ç½²æ§åˆ¶é¢æ¿è§¦å‘ / triggered from deployment control panel"
        required: false
        default: "false"
  repository_dispatch:
    types: [deploy-spa-button]

jobs:
  check-config:
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ” æ£€æŸ¥éƒ¨ç½²é…ç½®
        id: check
        run: |
          # æ‰‹åŠ¨è§¦å‘ï¼ˆActions é¡µé¢ / å¤–éƒ¨ä»“åº“ï¼‰æ—¶ï¼Œæ€»æ˜¯éƒ¨ç½²ï¼Œå¿½ç•¥è‡ªåŠ¨éƒ¨ç½²å¼€å…³
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… æ‰‹åŠ¨è§¦å‘ï¼ˆrepository_dispatchï¼‰ï¼Œå¿½ç•¥å¼€å…³ï¼Œå…è®¸éƒ¨ç½²"
            exit 0
          fi

          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.from_panel }}" != "true" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… æ‰‹åŠ¨è§¦å‘ï¼ˆworkflow_dispatchï¼‰ï¼Œå¿½ç•¥å¼€å…³ï¼Œå…è®¸éƒ¨ç½²"
            exit 0
          fi

          # è‡ªåŠ¨è§¦å‘ï¼ˆpush æˆ–æ§åˆ¶é¢æ¿è§¦å‘ï¼‰æ ¹æ®ä»“åº“çº§å˜é‡å†³å®šæ˜¯å¦éƒ¨ç½²
          SPA_ENABLED="${{ vars.SPA_DEPLOY }}"
          # é»˜è®¤è¡Œä¸ºï¼šå¦‚æœä»“åº“å˜é‡æœªè®¾ç½®ï¼Œè§†ä¸ºé»˜è®¤å…³é—­ï¼Œå¾—å»æ§åˆ¶é¢æ¿å¼€å¯
          [ -z "$SPA_ENABLED" ] && SPA_ENABLED="false"

          if [ "$SPA_ENABLED" = "true" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… SPA è‡ªåŠ¨éƒ¨ç½²å·²å¼€å¯ï¼Œå…è®¸éƒ¨ç½²"
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "â¸ï¸ SPA è‡ªåŠ¨éƒ¨ç½²å·²å…³é—­ï¼Œè·³è¿‡éƒ¨ç½²"
          fi

  deploy-spa:
    needs: check-config
    if: needs.check-config.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Check if deploy button trigger
        id: check-deploy-button
        run: |
          if [[ "${{ github.event_name }}" == "repository_dispatch" && "${{ github.event.action }}" == "deploy-spa-button" ]]; then
            echo "is_deploy_button=true" >> $GITHUB_OUTPUT
          else
            echo "is_deploy_button=false" >> $GITHUB_OUTPUT
          fi

      # ==================== æ­¥éª¤ 1ï¼šæ„å»ºå‰ç«¯ ====================
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: |
          echo "å®‰è£…å‰ç«¯ä¾èµ–..."
          npm ci

      - name: Build frontend
        working-directory: ./frontend
        run: |
          echo "æ„å»ºå‰ç«¯é™æ€èµ„æº..."
          npm run build
        env:
          VITE_APP_ENV: production
          VITE_ENABLE_DEVTOOLS: false

      - name: Verify frontend build
        run: |
          echo "âœ… éªŒè¯å‰ç«¯æ„å»ºäº§ç‰©..."
          if [ ! -d "frontend/dist" ]; then
            echo "âŒ å‰ç«¯æ„å»ºå¤±è´¥ï¼šdist ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

          if [ ! -f "frontend/dist/index.html" ]; then
            echo "âŒ å‰ç«¯æ„å»ºå¤±è´¥ï¼šindex.html ä¸å­˜åœ¨"
            exit 1
          fi

          echo "å‰ç«¯æ„å»ºäº§ç‰©å¤§å°ï¼š"
          du -sh frontend/dist
          echo "å‰ç«¯æ–‡ä»¶æ•°é‡ï¼š"
          find frontend/dist -type f | wc -l

      # ==================== æ­¥éª¤ 2ï¼šå‡†å¤‡åç«¯éƒ¨ç½² ====================
      - name: Install backend dependencies
        working-directory: ./backend
        run: |
          echo "å®‰è£…åç«¯ä¾èµ–ï¼ˆä¸åŒ…å«å¯é€‰ä¾èµ–ï¼‰..."
          if npm ci --no-optional; then
            echo "âœ… npm ci æˆåŠŸ"
          else
            echo "âš ï¸ npm ci å¤±è´¥ï¼Œå°†ä½¿ç”¨npm installæ›´æ–°lockæ–‡ä»¶"
            npm install --no-optional
          fi

      - name: Disable wrangler telemetry
        working-directory: ./backend
        run: npx wrangler telemetry disable

      # ==================== æ­¥éª¤ 3ï¼šé…ç½® D1 æ•°æ®åº“ ====================
      - name: Create or verify D1 Database
        working-directory: ./backend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "æ£€æŸ¥å¹¶åˆ›å»º D1 æ•°æ®åº“..."
          DATABASE_LIST=$(npx wrangler d1 list --json 2>/dev/null || echo "[]")
          EXISTING_DB=$(echo "$DATABASE_LIST" | jq -r '.[] | select(.name=="cloudpaste-db") | .uuid')

          if [ -n "$EXISTING_DB" ]; then
            echo "âœ… æ‰¾åˆ°ç°æœ‰ D1 æ•°æ®åº“: $EXISTING_DB"
            DATABASE_ID=$EXISTING_DB
          else
            echo "åˆ›å»ºæ–°çš„ D1 æ•°æ®åº“..."
            CREATE_OUTPUT=$(npx wrangler d1 create cloudpaste-db 2>&1)

            if echo "$CREATE_OUTPUT" | grep -q "Successfully created DB"; then
              DATABASE_ID=$(echo "$CREATE_OUTPUT" | grep -oP "database_id = \"\K[^\"]+")
              if [ -z "$DATABASE_ID" ]; then
                DATABASE_ID=$(echo "$CREATE_OUTPUT" | grep -oP "([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})")
              fi
              echo "âœ… æ•°æ®åº“åˆ›å»ºæˆåŠŸ: $DATABASE_ID"
            else
              LIST_OUTPUT=$(npx wrangler d1 list --json 2>/dev/null || echo "[]")
              DATABASE_ID=$(echo "$LIST_OUTPUT" | jq -r '.[] | select(.name=="cloudpaste-db") | .uuid')

              if [ -z "$DATABASE_ID" ]; then
                echo "âŒ æ— æ³•åˆ›å»ºæˆ–æ‰¾åˆ° D1 æ•°æ®åº“"
                exit 1
              fi
            fi
          fi

          # æ›´æ–° wrangler.spa.toml ä¸­çš„ database_id
          echo "æ›´æ–° wrangler.spa.toml ä¸­çš„æ•°æ®åº“ ID..."
          sed -i -E "s/(database_id = \")[^\"]+(\"\s*$)/\1$DATABASE_ID\2/" wrangler.spa.toml

          # éªŒè¯æ›´æ–°
          if grep -q "$DATABASE_ID" wrangler.spa.toml; then
            echo "âœ… wrangler.spa.toml æ›´æ–°æˆåŠŸ"
          else
            echo "âŒ wrangler.spa.toml æ›´æ–°å¤±è´¥"
            exit 1
          fi

          echo "database_id=$DATABASE_ID" >> $GITHUB_ENV

      - name: Initialize D1 Database schema
        working-directory: ./backend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "åˆå§‹åŒ–æ•°æ®åº“è¡¨ç»“æ„..."
          npx wrangler d1 execute cloudpaste-db --file=./schema.sql || echo "âš ï¸ è¡¨å¯èƒ½å·²å­˜åœ¨ï¼Œç»§ç»­éƒ¨ç½²"

      # ==================== æ­¥éª¤ 4ï¼šè®¾ç½®ç¯å¢ƒå˜é‡ ====================
      - name: Set ENCRYPTION_SECRET environment variable
        working-directory: ./backend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ğŸ” æ£€æŸ¥ ENCRYPTION_SECRET é…ç½®..."

          # æ£€æŸ¥ wrangler.spa.toml ä¸­æ˜¯å¦æœ‰ç¡¬ç¼–ç çš„ ENCRYPTION_SECRET
          if grep -q "ENCRYPTION_SECRET =" wrangler.spa.toml; then
            echo "âš ï¸ æ£€æµ‹åˆ° wrangler.spa.toml ä¸­å­˜åœ¨ç¡¬ç¼–ç çš„ ENCRYPTION_SECRET"
            echo "ä¸ºç¡®ä¿ GitHub Actions çš„å¯†é’¥è®¾ç½®ç”Ÿæ•ˆï¼Œå°†ä»é…ç½®ä¸­ç§»é™¤"
            cp wrangler.spa.toml wrangler.spa.toml.bak
            sed -i '/ENCRYPTION_SECRET =/d' wrangler.spa.toml
            echo "âœ… å·²ç§»é™¤ç¡¬ç¼–ç çš„ ENCRYPTION_SECRET"
          fi

          # æ£€æŸ¥ GitHub ä¸­æ˜¯å¦å·²é…ç½® ENCRYPTION_SECRET
          if [[ -n "${{ secrets.ENCRYPTION_SECRET }}" ]]; then
            echo "âœ… GitHub ä¸­å·²é…ç½® ENCRYPTION_SECRET"
            GITHUB_HAS_SECRET=true
          else
            echo "âš ï¸ GitHub ä¸­æœªé…ç½® ENCRYPTION_SECRET"
            GITHUB_HAS_SECRET=false
          fi

          # ä½¿ç”¨ --name å‚æ•°æŒ‡å®š Worker åç§°
          # æ£€æŸ¥ cloudpaste-spa Worker ä¸­æ˜¯å¦å·²å­˜åœ¨ ENCRYPTION_SECRET
          set +e
          SECRET_LIST_OUTPUT=$(npx wrangler secret list --name cloudpaste-spa 2>&1)
          set -e

          if echo "$SECRET_LIST_OUTPUT" | grep -q "ENCRYPTION_SECRET"; then
            echo "âœ… cloudpaste-spa Worker ä¸­å·²å­˜åœ¨ ENCRYPTION_SECRET"
            WORKER_HAS_SECRET=true
          else
            echo "âš ï¸ cloudpaste-spa Worker ä¸­æœªæ£€æµ‹åˆ° ENCRYPTION_SECRET"
            WORKER_HAS_SECRET=false
          fi

          # å¦‚æœ Worker ä¸­å·²æœ‰å¯†é’¥ï¼Œè·³è¿‡åˆ›å»º
          if [[ "$WORKER_HAS_SECRET" == "true" ]]; then
            echo "âœ… Worker ä¸­å·²å­˜åœ¨ ENCRYPTION_SECRETï¼Œè·³è¿‡åˆ›å»º"
          else
            # ç¡®å®šå¯†é’¥å€¼
            if [[ "$GITHUB_HAS_SECRET" == "true" ]]; then
              echo "ä½¿ç”¨ GitHub ä¸­é…ç½®çš„ ENCRYPTION_SECRET å€¼"
              ENCRYPTION_VALUE="${{ secrets.ENCRYPTION_SECRET }}"
            else
              echo "ç”Ÿæˆéšæœº ENCRYPTION_SECRET å€¼"
              ENCRYPTION_VALUE=$(openssl rand -base64 32)
            fi

            # è®¾ç½®å¯†é’¥åˆ° cloudpaste-spa Worker
            set +e
            echo "æ­£åœ¨ä¸º cloudpaste-spa Worker è®¾ç½® ENCRYPTION_SECRET..."
            SECRET_PUT_OUTPUT=$(echo "$ENCRYPTION_VALUE" | npx wrangler secret put ENCRYPTION_SECRET --name cloudpaste-spa 2>&1)
            SECRET_RESULT=$?
            set -e

            echo "Secret put è¾“å‡º:"
            echo "$SECRET_PUT_OUTPUT" | grep -v "Please update to the latest version"

            if [ $SECRET_RESULT -ne 0 ]; then
              if echo "$SECRET_PUT_OUTPUT" | grep -q -E "(already in use|already exists|conflict)"; then
                echo "âš ï¸ å¯†é’¥å·²å­˜åœ¨ä½†æœªè¢«åˆ—è¡¨å‘½ä»¤æ£€æµ‹åˆ°ï¼Œç»§ç»­æ‰§è¡Œ"
              else
                set +e
                FINAL_CHECK=$(npx wrangler secret list --name cloudpaste-spa 2>&1)
                set -e

                if echo "$FINAL_CHECK" | grep -q "ENCRYPTION_SECRET"; then
                  echo "è™½ç„¶è®¾ç½®å¯†é’¥å¤±è´¥ï¼Œä½†å¯†é’¥ä¼¼ä¹å·²å­˜åœ¨ï¼Œç»§ç»­æ‰§è¡Œ"
                else
                  echo "âŒ è®¾ç½®å¯†é’¥å¤±è´¥ï¼Œä¸”å¯†é’¥ç¡®å®ä¸å­˜åœ¨"
                  echo "è¯¦ç»†é”™è¯¯ä¿¡æ¯: $SECRET_PUT_OUTPUT"
                  exit 1
                fi
              fi
            else
              echo "âœ… ENCRYPTION_SECRET å·²æˆåŠŸåˆ›å»º"
            fi
          fi

      # ==================== æ­¥éª¤ 5ï¼šéƒ¨ç½² SPA Worker ====================
      - name: Deploy to Cloudflare Workers (SPA Mode)
        working-directory: ./backend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ğŸš€ ä½¿ç”¨ SPA é…ç½®éƒ¨ç½²åˆ° Cloudflare Workers..."
          npx wrangler deploy --config wrangler.spa.toml 2>&1 | sed -E 's/https:\/\/[a-zA-Z0-9.-]*\.(workers|pages)\.dev/https:\/\/[REDACTED].\1.dev/g'

      # ==================== æ­¥éª¤ 6ï¼šéƒ¨ç½²åéªŒè¯ ====================
      - name: Display Success Information
        if: steps.check-deploy-button.outputs.is_deploy_button == 'true' && success()
        run: |
          echo "===================================================="
          echo "ğŸ‰ CloudPaste SPA å·²æˆåŠŸéƒ¨ç½²åˆ° Cloudflare Workers!"
          echo "===================================================="
          echo ""
          echo "âœ… éƒ¨ç½²æ¨¡å¼ï¼šWorkers + Static Assets ä¸€ä½“åŒ–"
          echo "âœ… Worker åç§°ï¼šcloudpaste-spa"
          echo "âœ… å‰ç«¯å’Œåç«¯å·²éƒ¨ç½²åˆ°åŒä¸€ä¸ª Worker"
          echo ""
          echo "åç»­æ­¥éª¤ï¼š"
          echo "1. è®¿é—®æ‚¨çš„ Worker URL (https://cloudpaste-spa.your-account.workers.dev)"
          echo "2. é¦–æ¬¡è®¿é—®ä¼šè‡ªåŠ¨åˆå§‹åŒ–æ•°æ®åº“"
          echo "3. ä½¿ç”¨é»˜è®¤ç®¡ç†å‘˜è´¦æˆ·ç™»å½• (admin/admin123)"
          echo "4. âš ï¸  ç«‹å³ä¿®æ”¹é»˜è®¤ç®¡ç†å‘˜å¯†ç "
          echo "5. åœ¨ç®¡ç†å‘˜é¢æ¿ä¸­é…ç½®æ‚¨çš„ S3 å…¼å®¹å­˜å‚¨"
          echo "6. ï¼ˆå¯é€‰ï¼‰åœ¨ Cloudflare Dashboard ä¸­ç»‘å®šè‡ªå®šä¹‰åŸŸå"
          echo ""
          echo "ä¼˜åŠ¿ï¼š"
          echo "- å‰åç«¯åŒæºè¯·æ±‚ï¼Œæ— è·¨åŸŸé—®é¢˜"
          echo "- å¯¼èˆªè¯·æ±‚ä¸è®¡è´¹ï¼Œæˆæœ¬é™ä½ 60%+"
          echo "- æ— éœ€å•ç‹¬ç®¡ç† Cloudflare Pages"
          echo "===================================================="

      - name: Display Troubleshooting Info
        if: failure()
        run: |
          echo "===================================================="
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œå¯èƒ½çš„è§£å†³æ–¹æ¡ˆ:"
          echo ""
          echo "1. å‰ç«¯æ„å»ºé—®é¢˜ï¼š"
          echo "   - æ£€æŸ¥ frontend/package.json ä¾èµ–æ˜¯å¦æ­£ç¡®"
          echo "   - éªŒè¯ npm run build åœ¨æœ¬åœ°æ˜¯å¦æˆåŠŸ"
          echo ""
          echo "2. åç«¯éƒ¨ç½²é—®é¢˜ï¼š"
          echo "   - ç¡®ä¿ wrangler.spa.toml é…ç½®æ­£ç¡®"
          echo "   - éªŒè¯ D1 æ•°æ®åº“æƒé™"
          echo "   - æ£€æŸ¥ CLOUDFLARE_API_TOKEN æƒé™ï¼ˆéœ€è¦ Workers:Edit, D1:Editï¼‰"
          echo ""
          echo "3. éªŒè¯ GitHub Secretsï¼š"
          echo "   - CLOUDFLARE_API_TOKEN: Workers å’Œ D1 ç¼–è¾‘æƒé™"
          echo "   - CLOUDFLARE_ACCOUNT_ID: Cloudflare è´¦æˆ· ID"
          echo "   - ENCRYPTION_SECRET: ï¼ˆå¯é€‰ï¼‰åŠ å¯†å¯†é’¥"
          echo ""
          echo "4. æŸ¥çœ‹ä¸Šæ–¹è¯¦ç»†é”™è¯¯ä¿¡æ¯ä»¥å®šä½é—®é¢˜"
          echo "===================================================="

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… SPA Workeréƒ¨ç½²æˆåŠŸï¼"
          else
            echo "âŒ SPA Workeréƒ¨ç½²å¤±è´¥ï¼"
          fi
